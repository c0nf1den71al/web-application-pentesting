# Insecure Deserialization
#Authentication #Deserialization

Insecure deserialization is when user-controllable data is deserialized by a website. This potentially enables an attacker to manipulate serialized objects in order to pass harmful data into the application code.

## Serialization Vs Deserialization
### Serialization
Serialization is the process of **converting complex data structures**, such as objects and their fields, **into a flatter format** that can be sent and received as a **sequential** stream of bytes.

### Deserialization
Deserialization is the process of **restoring** this **byte stream** to a fully functional **replica** of the **original** object, in the exact state as when it was **serialized**.

## Modifying Serialized Objects
When tampering with the data, as long as the attacker **preserves** a **valid serialized object**, the deserialization process will create a server-side object with the **modified attribute** values.

As a simple example, consider a website that uses a serialized `User` object to store data about a user's session in a cookie. If an attacker spotted this **serialized** object in an HTTP request, they might **decode it** to find the following byte stream:
```PHP
O:4:"User":2:{s:8:"username";s:6:"carlos";s:7:"isAdmin";b:0;}
```

The `isAdmin` attribute is an obvious point of interest. An attacker could simply **change** the **boolean** value of the attribute to `1` (true), **re-encode** the object, and **overwrite** their current cookie with this modified value. In isolation, this has no effect. However, if the website uses the cookie to check whether or not the user has access to an **admin** panel, the attacker could **elevate** their privileges.

## Modifying Data Types
**PHP-based** logic is particularly vulnerable to this kind of **manipulation** due to the behaviour of its loose comparison operator (`==`) when comparing different data types. For example, if you perform a loose **comparison** between an integer and a string, PHP will attempt to **convert** the **string** to an **integer**, meaning that `5 == "5"` evaluates to `true`.

As `0 == "Example" // true` if attacker **modified** the password attribute so that it contained the **integer** `0` instead of the expected string. As long as the stored password does **not** start with a number, the condition would always return `true`, enabling an **authentication bypass**.

## Magic Methods
Magic methods are a special **subset** of methods that you do not have to explicitly invoke. Instead, they are invoked **automatically** whenever a particular event or scenario occurs. Magic methods are a common feature of **object-oriented programming** in various languages. They are sometimes indicated by prefixing or surrounding the method name with **double-underscores**. Example magic methods:
|Method|Language|Description|
|---|---|---|
|`__construct()`|PHP|Invoked whenever an object of the class is instantiated.|
|`__init__`|Python|Similar to `__construct()` in PHP this is invoked whenever an object of a class is instantiated.|
|`__wakeup()`|PHP|This is invoked automatically during the **deserialization** process.|
|`ObjectInputStream.readObject()`|Java|This method is invoked during **deserialization**.|

Any classes that contain these types of **magic methods** allow you to pass data from a **serialized** object into the **website's code** before the object is fully **deserialized**. This is the starting point for creating more **advanced exploits**.

## Injecting Arbitrary Object
In **object-oriented programming**, the methods available to an object are determined by its class. Therefore, if an attacker can **manipulate** which class of object is being passed in as **serialized** data, they can influence what **code is executed** after, and even during, **deserialization**.

If an attacker has access to the **source code**, they can study all of the available classes in detail. To construct a simple exploit, they would look for classes containing **deserialization** [magic methods](Insecure%20Deserialization.md#Magic%20Methods), then check whether any of them perform dangerous operations on controllable data. The attacker can then pass in a **serialized** object of this class to use its [magic method](Insecure%20Deserialization.md#Magic%20Methods) for an exploit.

## Gadget Chains