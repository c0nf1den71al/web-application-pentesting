# HTTP Request Smuggling
 #HTTP-Headers #Request-Smuggling

HTTP request smuggling is a technique for interfering with the way a web site processes sequences of HTTP requests that are received from one or more users. 

Most HTTP request smuggling vulnerabilities arise because the HTTP specification provides **two different** ways to specify where a request **ends**: the `Content-Length` header and the `Transfer-Encoding` header.

## Content-Length and Transfer-Encoding
### Content-Length
The `Content-Length` header specifies the **length** of the message body in **bytes**. An example of this can be seen in the request below:
```Request
POST /search HTTP/1.1
Host: google.com
Content-Type: application/x-www-form-urlencded
Content-Length: 6

q=cats
```

### Transfer-Encoding
The `Transfer-Encoding` header can be used to specify that the message body uses **chuncked encoding**. This means that the message body contains one or more chunks of data. Each chunk consists of the **chunk size** in bytes (expressed in hex) followed by a **newline**, followed by the **chunk contents**. Each message is **terminated** with a chunk with a size of **zero**. For example:
```Request
Post /search HTTP/1.1
Host: google.com
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked

6
s=cats
0
```

## Types Of Request Smuggling Attack
Request smuggling attacks involve placing **both** the `Content-Length` header and the `Transfer-Encoding` header into a single **HTTP** request and **manipulating** these so that the front-end and back-end servers process the request **differently**. The exact way in which this is done depends on the **behaviour** of the two servers:
|Type Of Attack|Explanation|
|---|---|
|CL.TE|The front-end server uses the `Content-Length` header and the back-end server uses the `Transfer-Encoding` header.|
|TE.CL|The front-end server uses the `Transfer-Encoding` header and the back-end server uses the `Content-Length` header.|
|TE.TE|The front-end and back-end servers both support the `Transfer-Encoding` header, but one of the servers can be induced not to process it by obfuscating the header in some way.|

## CL.TE Vulnerabilities
```Request
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 13
Transfer-Encoding: chunked

0

SMUGGLED
```

1. The **front-end** server processes the `Content-Length` header and determines that the request body is **13 bytes long**, up to the end of `SMUGGLED`. This request is forwarded on to the back-end server.
2. The **back-end** server processes the `Transfer-Encoding` header, and so treats the message body as using chunked encoding. It processes the first chunk, which is stated to be **zero** length, and so is treated as terminating the request. The following bytes, `SMUGGLED`, are left **unprocessed**, and the back-end server will treat these as being the **start of the next request** in the sequence.

## TE.CL Vulnerabilities
```Request
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 3
Transfer-Encoding: chunked

8
SMUGGLED
0
```

1. The **front-end** server processes the `Transfer-Encoding` header, and so treats the message body as using **chunked** encoding. It processes the first chunk, which is stated to be 8 bytes long, up to the start of the line following `SMUGGLED`. It processes the second chunk, which is stated to be zero length, and so is treated as **terminating** the request. This request is **forwarded** on to the **back-end** server.
2. The **back-end** server processes the `Content-Length` header and determines that the request body is **3 bytes** long, up to the start of the line following `8`. The following bytes, starting with `SMUGGLED`, are left **unprocessed**, and the **back-end** server will treat these as being the start of the next request in the sequence.

## TE.TE Vulnerabilities
Both the **front-end** and **back-end** servers support the `Transfer-Encoding` header, but one of the servers can be induced not to process it by obfuscating it in some way. Below are some example ways obfuscate the `Transfer-Encoding` header:

* `Transfer-Encoding: xchunked 
* `Transfer-Encoding : chunked`
* `Transfer-Encoding: chunked`<br>`Transfer-Encoding: x`
* `Transfer-Encoding:[tab]chunked`
* `[space]Transfer-Encoding: chunked`
* `X: X[\n]Transfer-Encoding: chunked`
* `Transfer-Encoding`<br>`: chunked`