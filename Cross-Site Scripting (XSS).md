# Cross-Site Scripting (XSS)
#AngularJS #Character-Encoding #Cookies #CSP #CSRF #DOM #XSS 

Cross-site scripting (XSS) works by **manipulating** a vulnerable web site so that it returns malicious **JavaScript** to users. When the malicious code executes inside a victim's browser, the attacker can fully **compromise** their interaction with the application.

## Reflected
Reflected XSS is the simplest variety of cross-site scripting. It arises when an application receives data in an HTTP request and includes that data within the **immediate response** in an unsafe way.

An example of Reflected XSS is within a URI. For example: 
`https://insecure-website.com/status?message=<script>/*+Bad+stuff+here...+*/</script> <p>Status: <script>/* Bad stuff here... */</script></p>`

## Stored
Stored XSS (also known as persistent or second-order XSS) arises when an application receives data from an untrusted source and includes that data within its later HTTP responses in an unsafe way.

A **common** place where you might find Stored XSS is within a blog posts comments section. The contents of the comments could be:
`<p><script>/* Bad stuff here... */</script></p>` 

## DOM-Based
DOM-based XSS (also known as DOM XSS) arises when an application contains some client-side JavaScript that processes data from an **untrusted source** in an unsafe way, usually by writing the data back to the **DOM**.

This is often seen within a **search bar** if a message is returned such as "0 results for 'code'". This can be abused with a payload such as:
`a"><img src="x" onerror="alert(1)">`

### DOM XSS Combined With Reflected and Stored Data
In a reflected DOM vulnerability, the server **processes** data from the request, and echoes the data into the **response**. The reflected data might be placed into a JavaScript string literal, or a data item within the **DOM**, such as a form field. A script on the page then **processes** the **reflected** data in an **unsafe** way, ultimately writing it to a dangerous sink.
`eval('var data = "reflected string"');`

## Execution Of JavaScript
### Via URL/Link
JavaScript can be executed via a URL when the URL starts with `javascript:`. This can be used within a `href` or `src` attribute in order to **execute** the malicious code. [List of HTML attributes with a URL value ](https://stackoverflow.com/questions/2725156/complete-list-of-html-tag-attributes-which-have-a-url-value)

### Via onEvent Attributes
JavaScript can also be executed by attributes which execute **on an event**, for example `onerror` or `onclick`. [List of HTML attributes which execute JavaScript](https://www.w3.org/TR/html401/interact/scripts.html#h-18.2.3)

## Encoding and Escaping
### Escaping Script Tags
In the simplest case, it is possible to simply **close** the script tag that is **enclosing** the existing JavaScript, and introduce some **new** HTML tags that will trigger execution of JavaScript.
```HTML
`</script><img src=1 onerror=alert(document.domain)>`
```

### Escaping JavaScript Literals
In cases where the XSS context is inside a **quoted** string **literal**, it is often possible to **break out** of the string and execute JavaScript directly. It is essential to **repair** the script following the XSS context, because any **syntax errors** there will prevent the whole script from executing.
```Javascript
'-alert(document.domain)-'
';alert(document.domain)/
```

### Escape Characters
Sometimes, characters such as `'` are **escaped** with a `\`. In this case `\'` will be escaped to `\\'` which can be used in an **XSS attack**, for example: 
```JavaScipt
\';alert(document.domain)//
```

Would be converted to 
```Javascript
\\';alert(document.domain)//
```

### HTML Encoding
When the browser has parsed out the HTML tags and attributes within a response, it will perform **HTML-decoding** of tag attribute values before they are processed any further. If the **server-side** application blocks or sanitizes certain characters that are needed for a successful XSS exploit, you can often **bypass** the input validation by **HTML-encoding** those characters. For example:
```Javascript
&apos;-alert(document.domain)-&apos;
```

## Custom Tags
Custom tags can be used to bypass tag filters. Example payload:
`<xss id=x onfocus=alert(document.cookie) tabindex=1>`

As `tabindex=1` specifies this element can be focused, this can then be called by adding `#x` to the URL. This means the final payload would be:
`/?search=%3Cxss+id%3Dx+onfocus%3Dalert(document.cookie)+tabindex%3D1%3E#x`

## JavaScript Template Literals
JavaScript template literals are string literals that allow **embedded** JavaScript **expressions**. The embedded expressions are **evaluated** and are normally **concatenated** into the surrounding text. Template literals are **encapsulated** in **backticks** instead of normal quotation marks, and **embedded expressions** are **identified** using the `${...}` syntax.

The following payload can be used to **execute** JavaScript **without** terminating the template literal:
```JavaScript
${alert(1)}
```

## AngularJS
### AngularJS Sandbox
The **AngularJS sandbox** is a mechanism that **prevents** access to potentially dangerous objects, such as `window` or `document`, in AngularJS template expressions. It also prevents access to potentially dangerous properties, such as `__proto__`. Despite not being considered a security **boundary** by the AngularJS team, the wider developer community generally thinks otherwise. Although **bypassing** the sandbox was initially challenging, security researchers have discovered numerous ways of doing so. As a result, it was eventually removed from AngularJS in **version 1.6**. However, many legacy applications still use older versions of AngularJS and may be vulnerable as a result.

### Template String Exploit
When AngularJS is in use, **template strings** are used where JavaScript code can be placed between **curly brackets**, for example `{{code}}`

This can be used to execute in a XSS attack such as:
``{{$on.constructor('alert(1)')()}}``

[Read more](https://portswigger.net/web-security/cross-site-scripting/contexts/angularjs-sandbox)